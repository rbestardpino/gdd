
--FUNCIONES AUXILIARES
--Devuelve a partir de la potencia el rango al que pertenece
CREATE FUNCTION TESTIGOS_DE_HENRY.RANGO_POTENCIA (@potencia INT) 
RETURNS NVARCHAR(255)
BEGIN
	RETURN CASE
		WHEN @potencia >= 50 AND @potencia <= 150 THEN '50-150'
		WHEN @potencia > 150 AND @potencia <= 300 THEN '151-300'
		WHEN @potencia > 300 THEN '> 300'
		ELSE 'Sin rango'
	END
END
GO

-- Devuelve a partir de la fecha de nacimiento el rango etario
CREATE FUNCTION TESTIGOS_DE_HENRY.RANGO_EDAD (@fecha_nacimiento datetime) 
RETURNS NVARCHAR(255)
BEGIN
	DECLARE @EDAD int
	SET @EDAD = DATEDIFF(YEAR, @fecha_nacimiento, GETDATE())

	RETURN CASE
		WHEN @EDAD >= 18 AND @EDAD <= 30 THEN '18 - 30'
		WHEN @EDAD > 30 AND @EDAD <= 50 THEN '31 - 50'
		WHEN @EDAD > 50 THEN '> 50'
		ELSE 'Sin rango'
	END
END
GO

--Devuelve el stock de un producto en un mes, un anio y una sucursal determinada
CREATE FUNCTION TESTIGOS_DE_HENRY.STOCK_A_LA_FECHA (@producto decimal(18,0), @mes decimal(18,0), @anio decimal(18,0), @sucursal decimal(18,0))
RETURNS DECIMAL(18,0)
BEGIN
	RETURN 
		(SELECT SUM(FC_AUTO_PARTE_UNIDADES_COMPRADAS) 
			FROM TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
			JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FC_AUTO_PARTE_TIEMPO = TIEMPO_ID
			WHERE 
				FC_AUTO_PARTE_AUTO_PARTE = @producto
				AND FC_AUTO_PARTE_SUCURSAL = @sucursal
				AND ((TIEMPO_ANIO < @anio) OR (TIEMPO_ANIO = @anio AND TIEMPO_MES <= @mes))) 
		- (SELECT SUM(FV_AUTO_PARTE_UNIDADES_VENDIDAS) 
			FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
			JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FV_AUTO_PARTE_TIEMPO = TIEMPO_ID
			WHERE 
				Fv_AUTO_PARTE_AUTO_PARTE = @producto
				AND FV_AUTO_PARTE_SUCURSAL = @sucursal
				AND ((TIEMPO_ANIO < @anio) OR (TIEMPO_ANIO = @anio AND TIEMPO_MES <= @mes))) 
END
GO

--CREACION DE DIMENSIONES, FACT TABLES Y MIGRACION DE DATOS
--TIEMPO
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_tiempo
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_TIEMPO (
        TIEMPO_ID   DECIMAL(18, 0) IDENTITY (1,1) NOT NULL,
        TIEMPO_MES  INT                           NOT NULL,
        TIEMPO_ANIO INT                           NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_TIEMPO
        ADD CONSTRAINT PK_BI_TIEMPO PRIMARY KEY (TIEMPO_ID);

	INSERT INTO TESTIGOS_DE_HENRY.BI_TIEMPO
		SELECT MONTH(COMPRA_FECHA), YEAR(COMPRA_FECHA)
		FROM TESTIGOS_DE_HENRY.COMPRA
		WHERE COMPRA_FECHA IS NOT NULL
        GROUP BY MONTH(COMPRA_FECHA), YEAR(COMPRA_FECHA)
        
	INSERT INTO TESTIGOS_DE_HENRY.BI_TIEMPO
		SELECT MONTH(FACTURA_FECHA), YEAR(FACTURA_FECHA)
		FROM TESTIGOS_DE_HENRY.FACTURA
		WHERE FACTURA_FECHA IS NOT NULL 
            AND NOT EXISTS(SELECT * FROM TESTIGOS_DE_HENRY.BI_TIEMPO WHERE TIEMPO_MES = MONTH(FACTURA_FECHA) AND TIEMPO_ANIO = YEAR(FACTURA_FECHA))
        GROUP BY MONTH(FACTURA_FECHA), YEAR(FACTURA_FECHA)
GO

--CLIENTE
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_cliente
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_CLIENTE (
        CLIENTE_ID   DECIMAL(18, 0) NOT NULL,
        CLIENTE_EDAD NVARCHAR(255),
        CLIENTE_SEXO VARCHAR
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_CLIENTE
        ADD CONSTRAINT PK_BI_CLIENTE PRIMARY KEY (CLIENTE_ID);
	INSERT INTO TESTIGOS_DE_HENRY.BI_CLIENTE (CLIENTE_ID, CLIENTE_EDAD)
		SELECT DISTINCT CLIENTE_ID, TESTIGOS_DE_HENRY.RANGO_EDAD (CLIENTE_FECHA_NAC)
		FROM TESTIGOS_DE_HENRY.Cliente
		WHERE CLIENTE_ID IS NOT NULL
        GROUP BY CLIENTE_ID, TESTIGOS_DE_HENRY.RANGO_EDAD (CLIENTE_FECHA_NAC)
        ORDER BY CLIENTE_ID
GO

--SUCURSAL
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_sucursal
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_SUCURSAL (
        SUCURSAL_ID     DECIMAL(18, 0) NOT NULL,
        SUCURSAL_CIUDAD NVARCHAR(255)  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_SUCURSAL
        ADD CONSTRAINT PK_BI_SUCURSAL PRIMARY KEY (SUCURSAL_ID);
	
	INSERT INTO TESTIGOS_DE_HENRY.BI_SUCURSAL
		SELECT DISTINCT sucursal_id, sucursal_ciudad
		FROM TESTIGOS_DE_HENRY.Sucursal
		WHERE sucursal_id is not null
        ORDER BY SUCURSAL_ID
GO

--TIPO CAJA
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_tipo_caja
AS
    CREATE TABLE TESTIGOS_DE_HENRY.BI_TIPO_CAJA (
        TIPO_CAJA_CODIGO           DECIMAL(18, 0) NOT NULL,
        TIPO_CAJA_DESC             NVARCHAR(255)  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_TIPO_CAJA
        ADD CONSTRAINT PK_BI_TIPO_CAJA PRIMARY KEY (TIPO_CAJA_CODIGO);


	INSERT INTO TESTIGOS_DE_HENRY.BI_TIPO_CAJA(TIPO_CAJA_CODIGO,TIPO_CAJA_DESC)
		SELECT DISTINCT TIPO_CAJA_CODIGO, TIPO_CAJA_DESC
		FROM TESTIGOS_DE_HENRY.TIPO_CAJA
		WHERE TIPO_CAJA_CODIGO IS NOT NULL
        ORDER BY TIPO_CAJA_CODIGO
GO

--TIPO MOTOR
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_tipo_motor
AS
    CREATE TABLE TESTIGOS_DE_HENRY.BI_TIPO_MOTOR
    (
        TIPO_MOTOR_CODIGO DECIMAL(18, 0) NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_TIPO_MOTOR
        ADD CONSTRAINT PK_BI_TIPO_MOTOR PRIMARY KEY (TIPO_MOTOR_CODIGO);
	
	INSERT INTO TESTIGOS_DE_HENRY.BI_TIPO_MOTOR
		SELECT DISTINCT TIPO_MOTOR_CODIGO
		FROM TESTIGOS_DE_HENRY.TIPO_MOTOR
		WHERE TIPO_MOTOR_CODIGO IS NOT NULL
		ORDER BY TIPO_MOTOR_CODIGO
GO

--TIPO TRANSMISION
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_tipo_transmision
AS
    CREATE TABLE TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION (
        TIPO_TRANSMISION_CODIGO DECIMAL(18, 0) NOT NULL,
        TIPO_TRANSMISION_DESC   NVARCHAR(255)  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION
        ADD CONSTRAINT PK_BI_TIPO_TRANSMISION PRIMARY KEY (TIPO_TRANSMISION_CODIGO);
	
	INSERT INTO TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION
		SELECT DISTINCT TIPO_TRANSMISION_CODIGO, TIPO_TRANSMISION_DESC
		FROM TESTIGOS_DE_HENRY.TIPO_TRANSMISION
		WHERE TIPO_TRANSMISION_CODIGO IS NOT NULL
		ORDER BY TIPO_TRANSMISION_CODIGO
GO

--TIPO AUTO
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_tipo_auto
AS
    CREATE TABLE TESTIGOS_DE_HENRY.BI_TIPO_AUTO (
        TIPO_AUTO_CODIGO DECIMAL(18, 0) NOT NULL,
        TIPO_AUTO_DESC   NVARCHAR(255)  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_TIPO_AUTO
        ADD CONSTRAINT PK_BI_TIPO_AUTO PRIMARY KEY (TIPO_AUTO_CODIGO);

	INSERT INTO TESTIGOS_DE_HENRY.BI_TIPO_AUTO
		SELECT DISTINCT TIPO_AUTO_CODIGO, TIPO_AUTO_DESC
		FROM TESTIGOS_DE_HENRY.TIPO_AUTO 
		WHERE TIPO_AUTO_CODIGO IS NOT NULL
		ORDER BY TIPO_AUTO_CODIGO
GO

--POTENCIA
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_potencia
AS
    CREATE TABLE TESTIGOS_DE_HENRY.BI_POTENCIA (
        POTENCIA_ID    DECIMAL(18, 0) IDENTITY (1, 1) NOT NULL,
        POTENCIA_RANGO NVARCHAR(255)                  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_POTENCIA
        ADD CONSTRAINT PK_BI_POTENCIA PRIMARY KEY (POTENCIA_ID);
	INSERT INTO TESTIGOS_DE_HENRY.BI_POTENCIA (POTENCIA_RANGO) VALUES ('50-150'), ('151-300'), ('> 300'), ('Sin rango')
GO

--FABRICANTE
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_fabricante
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_FABRICANTE (
        FABRICANTE_ID     DECIMAL(18, 0) NOT NULL,
        FABRICANTE_NOMBRE NVARCHAR(255)  NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FABRICANTE
        ADD CONSTRAINT PK_BI_FABRICANTE PRIMARY KEY (FABRICANTE_ID);
	
	INSERT INTO TESTIGOS_DE_HENRY.BI_FABRICANTE
		SELECT DISTINCT FABRICANTE_ID, FABRICANTE_NOMBRE
		FROM TESTIGOS_DE_HENRY.FABRICANTE
		WHERE FABRICANTE_NOMBRE IS NOT NULL
GO

--MODELO
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_modelo
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_MODELO (
        MODELO_CODIGO           DECIMAL(18, 0) NOT NULL,
        MODELO_NOMBRE           NVARCHAR(255)  NOT NULL,
        MODELO_POTENCIA         DECIMAl(18,0) NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_MODELO
        ADD CONSTRAINT PK_BI_MODELO PRIMARY KEY (MODELO_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_MODELO
        ADD CONSTRAINT FK_BI_MODELO_POTENCIA FOREIGN KEY (MODELO_POTENCIA) REFERENCES TESTIGOS_DE_HENRY.BI_POTENCIA (POTENCIA_ID);

	INSERT INTO TESTIGOS_DE_HENRY.BI_MODELO(MODELO_CODIGO,MODELO_NOMBRE,MODELO_POTENCIA)
		SELECT DISTINCT 
			MODELO_CODIGO, 
			MODELO_NOMBRE, 
			(SELECT POTENCIA_ID FROM TESTIGOS_DE_HENRY.BI_POTENCIA WHERE POTENCIA_RANGO = TESTIGOS_DE_HENRY.RANGO_POTENCIA(ISNULL(MODELO_POTENCIA,0)))
		FROM TESTIGOS_DE_HENRY.MODELO
		WHERE MODELO_CODIGO IS NOT NULL
GO

--AUTOMOVIL
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_automovil
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL (
        AUTOMOVIL_ID         DECIMAL(18, 0) NOT NULL,
        AUTOMOVIL_MODELO     DECIMAL(18, 0) NOT NULL,
		AUTOMOVIL_TIPO_MOTOR       DECIMAL(18, 0) NOT NULL,
        AUTOMOVIL_TIPO_TRANSMISION DECIMAL(18, 0) NOT NULL,
        AUTOMOVIL_TIPO_CAJA        DECIMAL(18, 0) NOT NULL,
        AUTOMOVIL_TIPO_AUTO        DECIMAL(18, 0) NOT NULL,
		AUTOMOVIL_SUCURSAL DECIMAL(18,0) NOT NULL,
		AUTOMOVIL_PRECIO_COMPRA DECIMAL(18,2) NOT NULL,
		AUTOMOVIL_PRECIO_VENTA DECIMAL(18,2),
		AUTOMOVIL_FECHA_COMPRA SMALLDATETIME,
		AUTOMOVIL_FECHA_VENTA SMALLDATETIME,
		AUTOMOVIL_CLIENTE DECIMAL(18,0),
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT PK_BI_AUTOMOVIL PRIMARY KEY (AUTOMOVIL_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_MODELO FOREIGN KEY (AUTOMOVIL_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);
    
	ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_SUCURSAL FOREIGN KEY (AUTOMOVIL_SUCURSAL) REFERENCES TESTIGOS_DE_HENRY.BI_SUCURSAL (SUCURSAL_ID);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_TIPO_MOTOR FOREIGN KEY (AUTOMOVIL_TIPO_MOTOR) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_MOTOR (TIPO_MOTOR_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_TIPO_TRANSMISION FOREIGN KEY (AUTOMOVIL_TIPO_TRANSMISION) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION (TIPO_TRANSMISION_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_TIPO_CAJA FOREIGN KEY (AUTOMOVIL_TIPO_CAJA) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_CAJA (TIPO_CAJA_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_TIPO_AUTO FOREIGN KEY (AUTOMOVIL_TIPO_AUTO) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_AUTO (TIPO_AUTO_CODIGO);
    
	ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTOMOVIL
        ADD CONSTRAINT FK_BI_AUTOMOVIL_CLIENTE FOREIGN KEY (AUTOMOVIL_CLIENTE) REFERENCES TESTIGOS_DE_HENRY.BI_CLIENTE (CLIENTE_ID);

	INSERT INTO TESTIGOS_DE_HENRY.BI_AUTOMOVIL
		SELECT DISTINCT 
			AUTOMOVIL_ID,
			AUTOMOVIL_MODELO_CODIGO,
			AUTOMOVIL_TIPO_MOTOR_CODIGO,
			AUTOMOVIL_TIPO_TRANSMISION_CODIGO,
			AUTOMOVIL_TIPO_CAJA_CODIGO,
			AUTOMOVIL_TIPO_AUTO_CODIGO,
			COMPRA_SUCURSAL_ID,
			COMPRA_AUTOMOVIL_PRECIO,
			FACTURA_AUTOMOVIL_PRECIO,
			COMPRA_FECHA,
			FACTURA_FECHA,
			FACTURA_CLIENTE_ID
		FROM TESTIGOS_DE_HENRY.AUTOMOVIL
		LEFT JOIN TESTIGOS_DE_HENRY.COMPRA_AUTOMOVIL ON AUTOMOVIL_ID = COMPRA_AUTOMOVIL_AUTOMOVIL_ID
		LEFT JOIN TESTIGOS_DE_HENRY.COMPRA ON COMPRA_AUTOMOVIL_COMPRA_NRO = COMPRA_NRO
		LEFT JOIN TESTIGOS_DE_HENRY.FACTURA_AUTOMOVIL ON AUTOMOVIL_ID = FACTURA_AUTOMOVIL_AUTOMOVIL_ID
		LEFT JOIN TESTIGOS_DE_HENRY.FACTURA ON FACTURA_NRO = FACTURA_AUTOMOVIL_FACTURA_ID
		WHERE AUTOMOVIL_ID IS NOT NULL
		ORDER BY AUTOMOVIL_ID
GO

--AUTOPARTE
CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_auto_parte
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_AUTO_PARTE (
        AUTO_PARTE_CODIGO        DECIMAL(18,0) NOT NULL,
        AUTO_PARTE_DESCR         NVARCHAR(255)  NOT NULL,
        AUTO_PARTE_PRECIO_COMPRA DECIMAL(18, 2) NOT NULL,
        AUTO_PARTE_PRECIO_VENTA  DECIMAL(18, 2) NOT NULL,
        AUTO_PARTE_FABRICANTE    DECIMAL(18, 0) NOT NULL,
        AUTO_PARTE_MODELO        DECIMAL(18, 0) NOT NULL,
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTO_PARTE
        ADD CONSTRAINT PK_BI_AUTO_PARTE PRIMARY KEY (AUTO_PARTE_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTO_PARTE
        ADD CONSTRAINT FK_BI_AUTO_PARTE_FABRICANTE FOREIGN KEY (AUTO_PARTE_FABRICANTE) REFERENCES TESTIGOS_DE_HENRY.BI_FABRICANTE (FABRICANTE_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_AUTO_PARTE
        ADD CONSTRAINT FK_BI_AUTO_PARTE_MODELO FOREIGN KEY (AUTO_PARTE_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);

	INSERT INTO TESTIGOS_DE_HENRY.BI_AUTO_PARTE
		SELECT DISTINCT 
			AUTO_PARTE_CODIGO,
			AUTO_PARTE_DESCRIPCION,
			COMPRA_AUTO_PARTE_PRECIO,
			ITEM_FACTURA_PRECIO,
			COMPRA_AUTO_PARTE_FABRICANTE_ID,
			COMPRA_AUTO_PARTE_MODELO_CODIGO
		FROM TESTIGOS_DE_HENRY.AUTO_PARTE
		JOIN TESTIGOS_DE_HENRY.COMPRA_AUTO_PARTE ON COMPRA_AUTO_PARTE_AUTO_PARTE_CODIGO = AUTO_PARTE_CODIGO 
		JOIN TESTIGOS_DE_HENRY.COMPRA ON COMPRA_NRO = COMPRA_AUTO_PARTE_COMPRA_NRO
		LEFT JOIN TESTIGOS_DE_HENRY.ITEM_FACTURA ON ITEM_FACTURA_AUTO_PARTE_CODIGO = AUTO_PARTE_CODIGO
		WHERE AUTO_PARTE_CODIGO IS NOT NULL
		GROUP BY AUTO_PARTE_CODIGO,
			AUTO_PARTE_DESCRIPCION,
			COMPRA_AUTO_PARTE_PRECIO,
			ITEM_FACTURA_PRECIO,
			COMPRA_AUTO_PARTE_FABRICANTE_ID,
			COMPRA_AUTO_PARTE_MODELO_CODIGO
		ORDER BY AUTO_PARTE_DESCRIPCION
GO

CREATE PROC TESTIGOS_DE_HENRY.CREACION_DIMENSIONES
AS
	EXEC TESTIGOS_DE_HENRY.BI_migracion_cliente
	EXEC TESTIGOS_DE_HENRY.BI_migracion_sucursal
	EXEC TESTIGOS_DE_HENRY.BI_migracion_fabricante
	EXEC TESTIGOS_DE_HENRY.BI_migracion_potencia
	EXEC TESTIGOS_DE_HENRY.BI_migracion_tipo_auto
	EXEC TESTIGOS_DE_HENRY.BI_migracion_tipo_caja
	EXEC TESTIGOS_DE_HENRY.BI_migracion_tipo_transmision
	EXEC TESTIGOS_DE_HENRY.BI_migracion_tipo_motor
	EXEC TESTIGOS_DE_HENRY.BI_migracion_tiempo
	EXEC TESTIGOS_DE_HENRY.BI_migracion_modelo
	EXEC TESTIGOS_DE_HENRY.BI_migracion_auto_parte
	EXEC TESTIGOS_DE_HENRY.BI_migracion_automovil
GO

EXEC TESTIGOS_DE_HENRY.CREACION_DIMENSIONES
GO

CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_fact_compras_automovil
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL (
        FC_AUTO_TIEMPO   DECIMAL(18,0)  NOT NULL,
		FC_AUTO_SUCURSAL DECIMAL(18,0)  NOT NULL,
		FC_AUTO_MODELO DECIMAL(18,0) NOT NULL,
        FC_AUTO_TIPO_MOTOR       DECIMAL(18, 0) NOT NULL,
        FC_AUTO_TIPO_TRANSMISION DECIMAL(18, 0) NOT NULL,
        FC_AUTO_TIPO_CAJA        DECIMAL(18, 0) NOT NULL,
        FC_AUTO_TIPO_AUTO        DECIMAL(18, 0) NOT NULL,
		FC_AUTO_CANTIDAD_COMPRADA DECIMAL(18,0) NOT NULL,
		FC_AUTO_PRECIO_COMPRA_PROMEDIO DECIMAL(18,0) NOT NULL,
		FC_AUTO_TIEMPO_PROMEDIO_EN_STOCK DECIMAL(18,0) NOT NULL
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT PK_BI_FACT_COMPRA_AUTOMOVIL PRIMARY KEY (FC_AUTO_TIEMPO, FC_AUTO_SUCURSAL,FC_AUTO_MODELO,FC_AUTO_TIPO_MOTOR,FC_AUTO_TIPO_TRANSMISION,FC_AUTO_TIPO_CAJA,FC_AUTO_TIPO_AUTO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_TIEMPO FOREIGN KEY (FC_AUTO_TIEMPO) REFERENCES TESTIGOS_DE_HENRY.BI_TIEMPO (TIEMPO_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_MODELO FOREIGN KEY (FC_AUTO_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_SUCURSAL FOREIGN KEY (FC_AUTO_SUCURSAL) REFERENCES TESTIGOS_DE_HENRY.BI_SUCURSAL (SUCURSAL_ID);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_TIPO_MOTOR FOREIGN KEY (FC_AUTO_TIPO_MOTOR) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_MOTOR (TIPO_MOTOR_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_TIPO_TRANSMISION FOREIGN KEY (FC_AUTO_TIPO_TRANSMISION) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION (TIPO_TRANSMISION_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_TIPO_CAJA FOREIGN KEY (FC_AUTO_TIPO_CAJA) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_CAJA (TIPO_CAJA_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FC_AUTO_TIPO_AUTO FOREIGN KEY (FC_AUTO_TIPO_AUTO) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_AUTO (TIPO_AUTO_CODIGO);

	INSERT INTO TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL 
		SELECT
			TIEMPO_ID,
			SUCURSAL_ID,
			MODELO_CODIGO,
			TIPO_MOTOR_CODIGO,
        	TIPO_TRANSMISION_CODIGO,
        	TIPO_CAJA_CODIGO,
        	TIPO_AUTO_CODIGO,
			COUNT(DISTINCT AUTOMOVIL_ID),
			AVG(AUTOMOVIL_PRECIO_COMPRA),
			AVG(CASE WHEN AUTOMOVIL_FECHA_VENTA IS NULL THEN DATEDIFF(DAY,AUTOMOVIL_FECHA_COMPRA,GETDATE())
						ELSE DATEDIFF(DAY,AUTOMOVIL_FECHA_COMPRA,AUTOMOVIL_FECHA_VENTA) END)
		FROM TESTIGOS_DE_HENRY.BI_AUTOMOVIL 
		JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON TIEMPO_ID = (SELECT TIEMPO_ID WHERE YEAR(AUTOMOVIL_FECHA_COMPRA) = TIEMPO_ANIO AND MONTH(AUTOMOVIL_FECHA_COMPRA) = TIEMPO_MES)
		JOIN TESTIGOS_DE_HENRY.BI_SUCURSAL ON SUCURSAL_ID = AUTOMOVIL_SUCURSAL
		JOIN TESTIGOS_DE_HENRY.BI_MODELO ON MODELO_CODIGO = AUTOMOVIL_MODELO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_AUTO ON AUTOMOVIL_TIPO_AUTO = TIPO_AUTO_CODIGO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_CAJA ON AUTOMOVIL_TIPO_CAJA = TIPO_CAJA_CODIGO 
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_MOTOR ON AUTOMOVIL_TIPO_MOTOR = TIPO_MOTOR_CODIGO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION ON AUTOMOVIL_TIPO_TRANSMISION = TIPO_TRANSMISION_CODIGO
		GROUP BY TIEMPO_ID, SUCURSAL_ID, MODELO_CODIGO, TIPO_MOTOR_CODIGO, TIPO_TRANSMISION_CODIGO, TIPO_CAJA_CODIGO, TIPO_AUTO_CODIGO
GO

CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_fact_ventas_automovil
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL (
        FV_AUTO_TIEMPO   DECIMAL(18,0)  NOT NULL,
		FV_AUTO_SUCURSAL DECIMAL(18,0)  NOT NULL,
		FV_AUTO_MODELO DECIMAL(18,0) NOT NULL,
        FV_AUTO_TIPO_MOTOR       DECIMAL(18, 0) NOT NULL,
        FV_AUTO_TIPO_TRANSMISION DECIMAL(18, 0) NOT NULL,
        FV_AUTO_TIPO_CAJA        DECIMAL(18, 0) NOT NULL,
        FV_AUTO_TIPO_AUTO        DECIMAL(18, 0) NOT NULL,
        FV_AUTO_CLIENTE        DECIMAL(18, 0) NOT NULL,
		FV_AUTO_CANTIDAD_VENDIDA DECIMAL(18,0) NOT NULL,
		FV_AUTO_PRECIO_VENTA_PROMEDIO DECIMAL(18,0) NOT NULL,
		FV_AUTO_GANANCIA DECIMAL(18,2) NOT NULL,
    );

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT PK_BI_FACT_VENTA_AUTOMOVIL PRIMARY KEY (FV_AUTO_TIEMPO, FV_AUTO_SUCURSAL,FV_AUTO_MODELO,FV_AUTO_TIPO_MOTOR,FV_AUTO_TIPO_TRANSMISION,FV_AUTO_TIPO_CAJA,FV_AUTO_TIPO_AUTO,FV_AUTO_CLIENTE);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_TIEMPO FOREIGN KEY (FV_AUTO_TIEMPO) REFERENCES TESTIGOS_DE_HENRY.BI_TIEMPO (TIEMPO_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_MODELO FOREIGN KEY (FV_AUTO_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_SUCURSAL FOREIGN KEY (FV_AUTO_SUCURSAL) REFERENCES TESTIGOS_DE_HENRY.BI_SUCURSAL (SUCURSAL_ID);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_TIPO_MOTOR FOREIGN KEY (FV_AUTO_TIPO_MOTOR) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_MOTOR (TIPO_MOTOR_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_TIPO_TRANSMISION FOREIGN KEY (FV_AUTO_TIPO_TRANSMISION) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION (TIPO_TRANSMISION_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_TIPO_CAJA FOREIGN KEY (FV_AUTO_TIPO_CAJA) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_CAJA (TIPO_CAJA_CODIGO);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_TIPO_AUTO FOREIGN KEY (FV_AUTO_TIPO_AUTO) REFERENCES TESTIGOS_DE_HENRY.BI_TIPO_AUTO (TIPO_AUTO_CODIGO);

	ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
        ADD CONSTRAINT FK_BI_FV_AUTO_CLIENTE FOREIGN KEY (FV_AUTO_CLIENTE) REFERENCES TESTIGOS_DE_HENRY.BI_CLIENTE (CLIENTE_ID);
	
	INSERT INTO TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL 
		SELECT
			TIEMPO_ID,
			SUCURSAL_ID,
			MODELO_CODIGO,
			TIPO_MOTOR_CODIGO,
        	TIPO_TRANSMISION_CODIGO,
        	TIPO_CAJA_CODIGO,
        	TIPO_AUTO_CODIGO,
			CLIENTE_ID,
			COUNT(DISTINCT AUTOMOVIL_ID),
			AVG(AUTOMOVIL_PRECIO_VENTA),
			SUM(AUTOMOVIL_PRECIO_VENTA-AUTOMOVIL_PRECIO_COMPRA)
		FROM TESTIGOS_DE_HENRY.BI_AUTOMOVIL 
		JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON TIEMPO_ID = (SELECT TIEMPO_ID WHERE YEAR(AUTOMOVIL_FECHA_COMPRA) = TIEMPO_ANIO AND MONTH(AUTOMOVIL_FECHA_COMPRA) = TIEMPO_MES)
		JOIN TESTIGOS_DE_HENRY.BI_SUCURSAL ON SUCURSAL_ID = AUTOMOVIL_SUCURSAL
		JOIN TESTIGOS_DE_HENRY.BI_MODELO ON MODELO_CODIGO = AUTOMOVIL_MODELO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_AUTO ON AUTOMOVIL_TIPO_AUTO = TIPO_AUTO_CODIGO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_CAJA ON AUTOMOVIL_TIPO_CAJA = TIPO_CAJA_CODIGO 
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_MOTOR ON AUTOMOVIL_TIPO_MOTOR = TIPO_MOTOR_CODIGO
		JOIN TESTIGOS_DE_HENRY.BI_TIPO_TRANSMISION ON AUTOMOVIL_TIPO_TRANSMISION = TIPO_TRANSMISION_CODIGO
		JOIN TESTIGOS_DE_HENRY.BI_CLIENTE ON CLIENTE_ID = AUTOMOVIL_CLIENTE
		WHERE AUTOMOVIL_FECHA_VENTA IS NOT NULL
		GROUP BY TIEMPO_ID, SUCURSAL_ID, MODELO_CODIGO, TIPO_MOTOR_CODIGO, TIPO_TRANSMISION_CODIGO, TIPO_CAJA_CODIGO, TIPO_AUTO_CODIGO,CLIENTE_ID
GO

CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_fact_compras_auto_parte
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE (
		FC_AUTO_PARTE_TIEMPO   DECIMAL (18,0) NOT NULL,
		FC_AUTO_PARTE_SUCURSAL DECIMAL (18,0) NOT NULL,
		FC_AUTO_PARTE_FABRICANTE DECIMAL (18,0) NOT NULL,
		FC_AUTO_PARTE_MODELO DECIMAL (18,0) NOT NULL,
		FC_AUTO_PARTE_AUTO_PARTE DECIMAL (18,0) NOT NULL,
		FC_AUTO_PARTE_PRECIO_PROMEDIO_COMPRA   DECIMAL(18, 2) NOT NULL,
		FC_AUTO_PARTE_UNIDADES_COMPRADAS DECIMAL (18,0) NOT NULL,
    )

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT PK_BI_FACT_COMPRA_AUTO_PARTE PRIMARY KEY (FC_AUTO_PARTE_TIEMPO, FC_AUTO_PARTE_AUTO_PARTE, FC_AUTO_PARTE_SUCURSAL,FC_AUTO_PARTE_FABRICANTE,FC_AUTO_PARTE_MODELO)

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FC_AUTO_PARTE_TIEMPO FOREIGN KEY (FC_AUTO_PARTE_TIEMPO) REFERENCES TESTIGOS_DE_HENRY.BI_TIEMPO (TIEMPO_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FC_AUTO_PARTE_AUTO_PARTE FOREIGN KEY (FC_AUTO_PARTE_AUTO_PARTE) REFERENCES TESTIGOS_DE_HENRY.BI_AUTO_PARTE (AUTO_PARTE_CODIGO);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FC_AUTO_PARTE_SUCURSAL FOREIGN KEY (FC_AUTO_PARTE_SUCURSAL) REFERENCES TESTIGOS_DE_HENRY.BI_SUCURSAL (SUCURSAL_ID);
    
	ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FC_AUTO_PARTE_FABRICANTE FOREIGN KEY (FC_AUTO_PARTE_FABRICANTE) REFERENCES TESTIGOS_DE_HENRY.BI_FABRICANTE (FABRICANTE_ID);
    
	ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FC_AUTO_PARTE_MODELO FOREIGN KEY (FC_AUTO_PARTE_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);

	INSERT INTO TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE 
		SELECT
			TIEMPO_ID,
			SUCURSAL_ID,
			AUTO_PARTE_FABRICANTE,
			AUTO_PARTE_MODELO,
			AUTO_PARTE_CODIGO,
			AVG(AUTO_PARTE_PRECIO_COMPRA),
		   	ISNULL(SUM(COMPRA_AUTO_PARTE_CANTIDAD),0)	
		FROM TESTIGOS_DE_HENRY.BI_TIEMPO
      	LEFT JOIN TESTIGOS_DE_HENRY.COMPRA ON YEAR(COMPRA_FECHA) = TIEMPO_ANIO AND MONTH(COMPRA_FECHA) = TIEMPO_MES
		LEFT JOIN TESTIGOS_DE_HENRY.COMPRA_AUTO_PARTE ON COMPRA_NRO = COMPRA_AUTO_PARTE_COMPRA_NRO
		JOIN TESTIGOS_DE_HENRY.BI_SUCURSAL ON COMPRA_SUCURSAL_ID = SUCURSAL_ID
		JOIN TESTIGOS_DE_HENRY.BI_AUTO_PARTE ON COMPRA_AUTO_PARTE_AUTO_PARTE_CODIGO = AUTO_PARTE_CODIGO
		GROUP BY TIEMPO_ID, TIEMPO_ANIO, TIEMPO_MES, AUTO_PARTE_CODIGO, SUCURSAL_ID,AUTO_PARTE_FABRICANTE,AUTO_PARTE_MODELO
		ORDER BY TIEMPO_ID,AUTO_PARTE_CODIGO, SUCURSAL_ID,AUTO_PARTE_FABRICANTE,AUTO_PARTE_MODELO
GO

CREATE PROCEDURE TESTIGOS_DE_HENRY.BI_migracion_fact_ventas_auto_parte
AS
	CREATE TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE (
		FV_AUTO_PARTE_TIEMPO   DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_SUCURSAL DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_FABRICANTE DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_MODELO DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_AUTO_PARTE DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_PRECIO_PROMEDIO_VENTA   DECIMAL(18, 2) NOT NULL,
		FV_AUTO_PARTE_UNIDADES_VENDIDAS DECIMAL (18,0) NOT NULL,
		FV_AUTO_PARTE_GANANCIA DECIMAL (18,0) NOT NULL
    )

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT PK_BI_FACT_VENTA_AUTO_PARTE PRIMARY KEY (FV_AUTO_PARTE_TIEMPO, FV_AUTO_PARTE_AUTO_PARTE, FV_AUTO_PARTE_SUCURSAL,FV_AUTO_PARTE_FABRICANTE,FV_AUTO_PARTE_MODELO)

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FV_AUTO_PARTE_TIEMPO FOREIGN KEY (FV_AUTO_PARTE_TIEMPO) REFERENCES TESTIGOS_DE_HENRY.BI_TIEMPO (TIEMPO_ID);

    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FV_AUTO_PARTE_AUTO_PARTE FOREIGN KEY (FV_AUTO_PARTE_AUTO_PARTE) REFERENCES TESTIGOS_DE_HENRY.BI_AUTO_PARTE (AUTO_PARTE_CODIGO);
    
    ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FV_AUTO_PARTE_SUCURSAL FOREIGN KEY (FV_AUTO_PARTE_SUCURSAL) REFERENCES TESTIGOS_DE_HENRY.BI_SUCURSAL (SUCURSAL_ID);

	ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FV_AUTO_PARTE_FABRICANTE FOREIGN KEY (FV_AUTO_PARTE_FABRICANTE) REFERENCES TESTIGOS_DE_HENRY.BI_FABRICANTE (FABRICANTE_ID);
    
	ALTER TABLE TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
        ADD CONSTRAINT FK_BI_FV_AUTO_PARTE_MODELO FOREIGN KEY (FV_AUTO_PARTE_MODELO) REFERENCES TESTIGOS_DE_HENRY.BI_MODELO (MODELO_CODIGO);

	INSERT INTO TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE 
		SELECT
			TIEMPO_ID,
			SUCURSAL_ID,
			AUTO_PARTE_FABRICANTE,
			AUTO_PARTE_MODELO,
			AUTO_PARTE_CODIGO,
			AVG(ITEM_FACTURA_PRECIO),
			ISNULL(SUM(ITEM_FACTURA_CANTIDAD),0),
			SUM(ITEM_FACTURA_CANTIDAD*(ITEM_FACTURA_PRECIO-AUTO_PARTE_PRECIO_COMPRA))	
		FROM TESTIGOS_DE_HENRY.BI_TIEMPO
      	JOIN TESTIGOS_DE_HENRY.FACTURA ON YEAR(FACTURA_FECHA) = TIEMPO_ANIO AND MONTH(FACTURA_FECHA) = TIEMPO_MES
		JOIN TESTIGOS_DE_HENRY.ITEM_FACTURA ON FACTURA_NRO = ITEM_FACTURA_FACTURA_ID
		JOIN TESTIGOS_DE_HENRY.BI_SUCURSAL ON FACTURA_SUCURSAL_ID = SUCURSAL_ID
		JOIN TESTIGOS_DE_HENRY.BI_AUTO_PARTE ON ITEM_FACTURA_AUTO_PARTE_CODIGO = AUTO_PARTE_CODIGO
		GROUP BY TIEMPO_ID, TIEMPO_ANIO, TIEMPO_MES, AUTO_PARTE_CODIGO, SUCURSAL_ID,AUTO_PARTE_FABRICANTE,AUTO_PARTE_MODELO
		ORDER BY TIEMPO_ID,AUTO_PARTE_CODIGO, SUCURSAL_ID,AUTO_PARTE_FABRICANTE,AUTO_PARTE_MODELO
GO

CREATE PROC TESTIGOS_DE_HENRY.CREACION_FACT_TABLES
AS
	EXEC TESTIGOS_DE_HENRY.BI_migracion_fact_compras_automovil
	EXEC TESTIGOS_DE_HENRY.BI_migracion_fact_ventas_automovil
	EXEC TESTIGOS_DE_HENRY.BI_migracion_fact_compras_auto_parte
	EXEC TESTIGOS_DE_HENRY.BI_migracion_fact_ventas_auto_parte
GO

EXEC TESTIGOS_DE_HENRY.CREACION_FACT_TABLES
GO
-- VISTAS DE AUTOMOVILES
-- PUNTO 1: Cantidad de automóviles, vendidos y comprados x sucursal y mes 
CREATE VIEW TESTIGOS_DE_HENRY.Cantidad_automoviles_por_sucursal_y_mes
AS
	SELECT
		TIEMPO_ANIO AS ANIO,
		TIEMPO_MES AS MES,
		FC_AUTO_SUCURSAL AS SUCURSAL,
		SUM(FC_AUTO_CANTIDAD_COMPRADA) AS 'CANTIDAD COMPRADA',
		(SELECT SUM(FV_AUTO_CANTIDAD_VENDIDA) 
			FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
			WHERE FC_AUTO_TIEMPO = FV_AUTO_TIEMPO AND FC_AUTO_SUCURSAL = FV_AUTO_SUCURSAL) AS 'CANTIDAD VENDIDA'
	FROM TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
	JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON TIEMPO_ID = FC_AUTO_TIEMPO
	GROUP BY FC_AUTO_TIEMPO, TIEMPO_ANIO, TIEMPO_MES, FC_AUTO_SUCURSAL
GO

-- PUNTO 2: Precio promedio de automóviles, vendidos y comprados.
CREATE VIEW TESTIGOS_DE_HENRY.Precio_promedio_automoviles
AS
	SELECT
		FC_AUTO_MODELO AS 'MODELO',
		(SELECT AVG(FV_AUTO_PRECIO_VENTA_PROMEDIO) 
			FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
			WHERE FV_AUTO_MODELO = FC_AUTO_MODELO) AS 'PRECIO DE VENTA PROMEDIO',
		AVG(FC_AUTO_PRECIO_COMPRA_PROMEDIO) AS 'PRECIO DE COMPRA PROMEDIO'
	FROM TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
	JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FC_AUTO_TIEMPO = TIEMPO_ID
	GROUP BY FC_AUTO_MODELO
GO

--PUNTO 3: Ganancias (precio de venta - precio de compra) x Sucursal x mes 
CREATE VIEW TESTIGOS_DE_HENRY.Ganancias_automoviles_por_sucursal_y_mes
AS
	SELECT
		TIEMPO_ANIO AS ANIO,
		TIEMPO_MES AS MES,
		FV_AUTO_SUCURSAL AS SUCURSAL,
		SUM(FV_AUTO_GANANCIA) AS GANANCIA
	FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTOMOVIL
	JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FV_AUTO_TIEMPO = TIEMPO_ID
	GROUP BY TIEMPO_ANIO, TIEMPO_MES, FV_AUTO_SUCURSAL
GO

-- PUNTO 4: Promedio de tiempo en stock de cada modelo de automóvil.
CREATE VIEW TESTIGOS_DE_HENRY.Promedio_tiempo_por_modelo
AS
	SELECT
		FC_AUTO_MODELO AS MODELO,
		AVG(FC_AUTO_TIEMPO_PROMEDIO_EN_STOCK) AS 'TIEMPO EN STOCK'
	FROM TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTOMOVIL
	GROUP BY FC_AUTO_MODELO
GO

-- VISTAS AUTOPARTES
-- PUNTO 1: Precio promedio de cada autoparte, vendida y comprada. 
CREATE VIEW TESTIGOS_DE_HENRY.Precio_promedio_auto_partes
AS
	SELECT
		FC_AUTO_PARTE_AUTO_PARTE AS AUTOPARTE,
		AVG(FC_AUTO_PARTE_PRECIO_PROMEDIO_COMPRA) AS 'PRECIO PROMEDIO DE COMPRA',
		(SELECT AVG(FV_AUTO_PARTE_PRECIO_PROMEDIO_VENTA)
			FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
			WHERE FV_AUTO_PARTE_AUTO_PARTE = FC_AUTO_PARTE_AUTO_PARTE) 'PRECIO PROMEDIO DE VENTA'
	FROM TESTIGOS_DE_HENRY.BI_FACT_COMPRA_AUTO_PARTE
	GROUP BY FC_AUTO_PARTE_AUTO_PARTE, FC_AUTO_PARTE_PRECIO_PROMEDIO_COMPRA
GO

-- PUNTO 2: Ganancias (precio de venta - precio de compra) x Sucursal x mes 
CREATE VIEW TESTIGOS_DE_HENRY.Ganancias_autopartes_por_sucursal_y_mes
AS
	SELECT
		TIEMPO_ANIO,
		TIEMPO_MES,
		FV_AUTO_PARTE_SUCURSAL,
		SUM(FV_AUTO_PARTE_GANANCIA) AS GANANCIA
	FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
	JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FV_AUTO_PARTE_TIEMPO = TIEMPO_ID
	GROUP BY TIEMPO_ANIO, TIEMPO_MES, FV_AUTO_PARTE_SUCURSAL
GO

-- PUNTO 3: Máxima cantidad de stock por cada sucursal (anual) 
CREATE VIEW TESTIGOS_DE_HENRY.Maximo_stock_anual
AS
	SELECT
		TIEMPO_ANIO AS ANIO,
		FV_AUTO_PARTE_SUCURSAL AS SUCURSAL,
		MAX(TESTIGOS_DE_HENRY.STOCK_A_LA_FECHA(FV_AUTO_PARTE_AUTO_PARTE,TIEMPO_MES,TIEMPO_ANIO,FV_AUTO_PARTE_SUCURSAL)) AS 'MAXIMO STOCK ANUAL'
	FROM TESTIGOS_DE_HENRY.BI_FACT_VENTA_AUTO_PARTE
	JOIN TESTIGOS_DE_HENRY.BI_TIEMPO ON FV_AUTO_PARTE_TIEMPO = TIEMPO_ID
	GROUP BY TIEMPO_ID, TIEMPO_ANIO, FV_AUTO_PARTE_SUCURSAL
GO